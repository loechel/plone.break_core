# -*- coding: utf-8 -*-

from pkg_resources import parse_version, Requirement
from setuptools import package_index

from .config import logger
from .config import VULNERABILITY_DB_URL

import json
import urllib2


class PloneCoreVulnerabilityChecker(object):
    """

    """

    def __init__(self, version, patch_list=[]):
        """

        """
        self.version = version

        data = None

        try:
            # Request Vulnerability data base for version
            request = urllib2.Request(
                VULNERABILITY_DB_URL+"hotfix_json?version="+version)
            response = urllib2.urlopen(request, timeout=5)
            data = json.load(response)

            ## relevant Pattern of response 
            #data = { 
            #   'hotfixes':[],
            #   'security':True,
            #   'maintenance':True,
            ## additional data:
            #   'name': version_number,
            #   'date' : release_date,
            #   }

        except urllib2.URLError:
            # Requested a URL that eigther don't exists, or respond.
            data = None # nessesary? 

        if data == None:
            # If the requested version is not avaliable or an Error 
            # on request has happend 
            # --> declare default data set emtpy and system as secure
            data = {}

        self._in_security_support = data.get(u'security', True)
        self._in_active_maintenance_support = data.get(u'maintenance', True)
        self._hotfixes = data.get(u'hotfixes', [])
        patch_prefix = 'Products.PloneHotfix'
        self._patches = []

        for hotfix in self._hotfixes:
            self._patches.append(patch_prefix+hotfix[u'name'])

        if self._hotfixes is None or self._hotfixes == []:
            self._is_secure = True
        else:
            if self._patches in patch_list:
                self._is_secure = True
            else:
                self._is_secure = False

    def get_patches(self):
        """

        """
        return self.patches

    def is_secure(self):
        """

        """
        return self._is_secure

    def is_in_security_support(self):
        """

        """
        return self._in_security_support

    def is_in_active_maintenance_support(self):
        """

        """
        return self._in_active_maintenance_support